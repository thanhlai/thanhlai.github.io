<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Offline Activation Keygen</title>
</head>

<body>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css" />
    <script language="javascript" type="text/javascript">
        function limitText(limitField, limitNum) {
            if (limitField.value.length > limitNum) {
                limitField.value = limitField.value.substring(0, limitNum);
            }
        }
    </script>

    <div id="formularioEdicao" class="container">
        <h3 class="main-title center">Music Bingo On-premise Activation Keygen v0.0.3
        </h3>
        <div class="row">
            <div class="col s12">
                <div class="section">
                    <h5>Activation Info</h5>
                    
                    <!--
                    <div class="row">
                        <div class="input-field col s12">
                            <input id="macaddress" type="text" />
                            <label for="macaddress">Device ID</label>
                        </div>
                    </div>
                    -->
                    
                     <div class="row">
                        <div class="col s12">
                          <div class="row">
                            <div class="input-field col s12">
                              <input type="text" id="macaddress" class="autocomplete">
                              <label for="autocomplete-input">Device Name or ID</label>
                            </div>
                          </div>
                        </div>
                      </div>
                    
                    <div class="row">
                        <div class="input-field col s12">
                            <input id="redemptionDate" type="date" class="datepicker" />
                            <label for="redemptionDate">Redemption Date*</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input id="numberOfGames" type="number" onKeyDown="limitText(this, 2)" />
                            <label for="numberOfGames">Maximum Number of Games**</label>
                        </div>
                    </div>

                </div>

                <div class="row">
                    <div class="input-field col s12 center">
                        <button type="button" onclick="generate()"
                            class="btn waves-effect waves-light">Generate</button>
                    </div>
                </div>
            </div>

            <p>*: is the only day in which the user will be able to activate their key. Upon activation, the user's
                device date will be validated against the encrypted checksum on the generated key for security
                measurement.</p>
            <p>**: the maximum allowed of 999 games per key.</p>
        </div>

    </div>

    <div id="modal1" class="modal">
        <div class="modal-content">
            <h4>Activation Code</h4>
            <p>Please copy the activation key below and send to the client.</p>
            <h2 id="activationKey" style="letter-spacing: 4px; color: #4885ed"></h2>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-action waves-effect waves-green btn-flat"
                onclick="copyToClipboard('#activationKey')"> <span class="tooltiptext" id="copyTooltip"></span></a>
            <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat">Close</a>
        </div>
    </div>


    <script>
        $(function () {

            $(document).ready(function () {
                $('.datepicker').pickadate({
                    selectMonths: true,
                    selectYears: 20
                })
                $('select').material_select()

                $('.modal').modal()

            });
        })</script>

    <script>

        function generate() {
            var plain = ""
            // input
            var macaddress = $('#macaddress').val().split(delimiter)[0]
            macaddress = macaddress.toUpperCase().split(':')
            var redemptionDate = $('#redemptionDate').val()
            var numberOfGames = $('#numberOfGames').val()

            // verify input
            if (!numberOfGames || parseInt(numberOfGames) == 0 || !redemptionDate || macaddress.length != 6) {
                Materialize.toast('Invalid information. Please complete all input fields and try again.', 4000)
                if (parseInt(numberOfGames) == 0) {
                    Materialize.toast('Maximum number of games cannot be zero.', 4000)
                }
                return
            }


            // macaddress serial part
            var serialParts = macaddress.slice(Math.max(macaddress.length - 3, 1))
            var serialPartLocationIndex = Math.floor(Math.random() * 10) // random from 0 to 9, will be mod 3
            var key9 = serialPartLocationIndex % 3
            var selectedSerialParts = serialParts[key9];
            // convert to base 10 from HEX
            var key0 = parseInt(selectedSerialParts[0], 16) % 10
            var key8 = parseInt(selectedSerialParts[1], 16) % 10

            // # of games part
            var key1 = getDigit(numberOfGames, 3)
            var key2 = getDigit(numberOfGames, 2)
            var key3 = getDigit(numberOfGames, 1)

            // redemption date part
            var key45 = $('#redemptionDate').pickadate('picker').get('highlight', 'dd')
            var key67 = $('#redemptionDate').pickadate('picker').get('highlight', 'mm')

            plain = '' + key0 + key1 + key2 + key3 + key45 + key67 + key8 + key9;

            console.log(plain)

            // verify constructed text
            if (plain.length == 10) {
                var encrypted = encrypt(plain)
                $('#activationKey').text(encrypted)

                $('#copyTooltip').html("Copy to clipboard")
                $('#modal1').modal('open')
            }
            return "Cannot generate an activation code based on your input. Please check your info and try again."
        }

        function encrypt(plain) {

            var result = []

            var numberOfGames = '' + plain[1] + plain[2] + plain[3]

            for (var i = 0; i < plain.length; i++) {
                var encrypted = (plain[i] * plain[i] * plain[i]) % 10
                if (i != 1 && i != 2 && i != 3)
                    encrypted = (encrypted + 10 - numberOfGames % 10) % 10
                result.push(encrypted)
            }

            return result.join('')
        }


        // [1st last # of macaddress][# of games][# of games][# of games][dd][dd][mm][mm][2nd last bit of # of macaddress][which serial part of macaddress]


        function decrypt(key) {

            var result = []

            // decrypt # of games
            var key1 = (key[1] * key[1] * key[1]) % 10
            var key2 = (key[2] * key[2] * key[2]) % 10
            var key3 = (key[3] * key[3] * key[3]) % 10

            var numberOfGames = '' + key1 + key2 + key3

            for (var i = 0; i < key.length; i++) {
                var decrypted = (parseInt(numberOfGames) + parseInt(key[i])) % 10
                if (i == 1)
                    decrypted = key1
                else if (i == 2)
                    decrypted = key2
                else if (i == 3)
                    decrypted = key3
                else
                    decrypted = (decrypted * decrypted * decrypted) % 10

                result.push(decrypted)
            }

            return result.join('')
        }


        function getDigit(number, n) {
            return Math.floor((number / Math.pow(10, n - 1)) % 10)
        }

        function copyToClipboard(element) {
            var $temp = $("<input>")
            $("body").append($temp)
            $temp.val($(element).text()).select()
            document.execCommand("copy")
            $("#copyTooltip").html("Copied " + $(element).text())
            $temp.remove()
        }
        
        
let delimiter = ' | '
$(document).ready(function() {
  $(function() {
    $.ajax({
      type: 'GET',
      url: 'https://musicbingoweb.azurewebsites.net/api/device',
      dataType: 'jsonp',
      success: function(response) {
          
        var parsedJSON = JSON.parse(response)
        var devices = []
        for (var i = 0; i < parsedJSON.length; i++) {
           devices.push(parsedJSON[i].deviceID + delimiter + parsedJSON[i].name)
        }
        $('#macaddress').autocomplete({
          data: devices,
        })
          
      }
    })
  })
})
        

    </script>
</body>

</html>
